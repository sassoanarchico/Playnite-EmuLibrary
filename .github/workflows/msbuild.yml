name: Build and Release .pext

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

permissions:
  contents: write

env:
  SOLUTION_FILE_PATH: EmuLibrary.sln
  BUILD_CONFIGURATION: Release

jobs:
  build:
    runs-on: windows-latest

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 20

    - name: Get Version From Tag
      id: get_version
      shell: pwsh
      run: |
        if ($env:GITHUB_REF -match '^refs/tags/v(.+)$') {
          $version = $Matches[1]
        } else {
          # fallback: read from extension.yaml
          $line = Select-String -Path "EmuLibrary/extension.yaml" -Pattern "^\s*Version\s*:" | Select-Object -First 1
          $version = ($line.Line -split ":", 2)[1].Trim()
        }
        Write-Host "Version: $version"
        "VERSION=$version" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8
        "version=$version" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8

    - name: Update extension.yaml version
      shell: pwsh
      run: |
        $file = "EmuLibrary/extension.yaml"
        $content = Get-Content $file -Raw
        $content = $content -replace '(?m)^(\s*Version\s*:\s*).*$', "`${1}${{ env.VERSION }}"
        Set-Content $file -Value $content -NoNewline

    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v2

    - name: Setup NuGet
      uses: nuget/setup-nuget@v2

    - name: Restore NuGet packages
      run: nuget restore ${{ env.SOLUTION_FILE_PATH }}

    - name: Build
      run: msbuild /m /p:Configuration=${{ env.BUILD_CONFIGURATION }} ${{ env.SOLUTION_FILE_PATH }}

    - name: Rename Extension Package Prefix
      shell: pwsh
      run: |
        Get-ChildItem -File -Path '*.pext' | ForEach-Object {
          $newName = $_.Name -replace '^RomInstaller_', 'EmuLibrary_'
          $newPath = Join-Path $_.DirectoryName $newName
          Move-Item -Path $_.FullName -Destination $newPath
          Write-Host "Renamed: $($_.Name) -> $newName"
        }

    - name: Build Changelog
      id: github_release
      uses: mikepenz/release-changelog-builder-action@v5
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        commitMode: true

    - name: Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: v${{ env.VERSION }}
        name: EmuLibrary v${{ env.VERSION }}
        body: ${{ steps.github_release.outputs.changelog }}
        generate_release_notes: true
        files: "*.pext"
        fail_on_unmatched_files: true
        token: ${{ secrets.GITHUB_TOKEN }}